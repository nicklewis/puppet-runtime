From 57b2ef19b013dd1fd8660af28398d3d332d1ea97 Mon Sep 17 00:00:00 2001
From: Christopher Kohlhoff <chris@kohlhoff.com>
Date: Fri, 1 Mar 2019 16:13:25 +1100
Subject: [PATCH] Ensure SSL handshake errors are propagated to the peer.

---
 asio/include/asio/ssl/detail/impl/engine.ipp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/asio/include/asio/ssl/detail/impl/engine.ipp b/asio/include/asio/ssl/detail/impl/engine.ipp
index 07f9123db..81d8217aa 100644
--- a/asio/ssl/detail/impl/engine.ipp
+++ b/asio/ssl/detail/impl/engine.ipp
@@ -240,14 +240,16 @@ engine::want engine::perform(int (engine::* op)(void*, std::size_t),
   {
     ec = asio::error_code(sys_error,
         asio::error::get_ssl_category());
-    return want_nothing;
+    return pending_output_after > pending_output_before
+      ? want_output : want_nothing;
   }
 
   if (ssl_error == SSL_ERROR_SYSCALL)
   {
     ec = asio::error_code(sys_error,
         asio::error::get_system_category());
-    return want_nothing;
+    return pending_output_after > pending_output_before
+      ? want_output : want_nothing;
   }
 
   if (result > 0 && bytes_transferred)
